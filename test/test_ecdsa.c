/* Copyright 2014, Kenneth MacKay. Licensed under the BSD 2-clause license. */

#include "uECC.h"

#include <stdio.h>
#include <string.h>

int ECDSA_Cross_Dbl_UnitTest();
int ECDSA_Cross_O_UnitTest();

int main() {
    int i, c;
    uint8_t private[32] = {0};
    uint8_t public[64] = {0};
    uint8_t hash[32] = {0};
    uint8_t sig[64] = {0};

    const struct uECC_Curve_t * curves[5];
    int num_curves = 0;
#if uECC_SUPPORTS_secp160r1
    curves[num_curves++] = uECC_secp160r1();
#endif
#if uECC_SUPPORTS_secp192r1
    curves[num_curves++] = uECC_secp192r1();
#endif
#if uECC_SUPPORTS_secp224r1
    curves[num_curves++] = uECC_secp224r1();
#endif
#if uECC_SUPPORTS_secp256r1
    curves[num_curves++] = uECC_secp256r1();
#endif
#if uECC_SUPPORTS_secp256k1
    curves[num_curves++] = uECC_secp256k1();
#endif
    
    printf("Testing 256 signatures\n");
    for (c = 0; c < num_curves; ++c) {
        for (i = 0; i < 256; ++i) {
            printf(".");
            fflush(stdout);

            if (!uECC_make_key(public, private, curves[c])) {
                printf("uECC_make_key() failed\n");
                return 1;
            }
            memcpy(hash, public, sizeof(hash));
            
            if (!uECC_sign(private, hash, sizeof(hash), sig, curves[c])) {
                printf("uECC_sign() failed\n");
                return 1;
            }

            if (!uECC_verify(public, hash, sizeof(hash), sig, curves[c])) {
                printf("uECC_verify() failed\n");
                return 1;
            }
        }
        printf("\n");
    }

	printf("Testing Dbl/O bugs. \n");
	ECDSA_Cross_Dbl_UnitTest();
	ECDSA_Cross_O_UnitTest();
    
    return 0;
}


int ECDSA_Cross_Dbl_UnitTest()
{
	uECC_Curve curve = uECC_secp224r1();

	// publicKey = 
	// 7396879990097586236124086381004726978399111812774780579416589330252, 
	// 15246521408824381252424799282012452115848512063096734335658261874154
	uint8_t publicKey[56] = {
		0x46,0x3C,0xD1,0xB7,0xFB,0xF4,0x42,0x14,0x05,0x42,0x28,0x2F,0x25,0x88,0xB1,0x73,0x52,0x62,0x75,0x8B,0x11,0xD4,0xE1,0x9D,0x1F,0xA1,0xE7,0x4C,
		0x90,0xC6,0x3D,0x90,0xEE,0x3B,0x07,0xB1,0x16,0x71,0x37,0x9F,0x95,0x1C,0x65,0x85,0xD5,0xF3,0x42,0xF8,0xC7,0x1D,0xC6,0x19,0xC7,0x7A,0x05,0xEA
	};

	// hash = {1118211616302558700907941663330228202221131184932693093213431342177}
	uint8_t hash[28] = {
		0x0A,0x9E,0x38,0xCC,0x16,0x2B,0x19,0xD2,0x2B,0x8D,0x75,0x38,0xCF,0x25,0x88,0x60,0x31,0x74,0xE6,0x50,0xF6,0x68,0xCE,0xEC,0x94,0xDF,0x24,0x61
	};

	// r,s = 
	// {11210666069028466100279750333981700099527404332952150768292734963065}, 
	// {5363638219116483982032748356733932124313117719358176702347125630951}
	uint8_t signature[56] = {
		0x6A,0x73,0x9E,0x9F,0x4C,0x31,0x72,0xC7,0xB8,0x7E,0x77,0xB9,0xC3,0x03,0xCB,0x59,0xEA,0x21,0x1F,0xB4,0x29,0x31,0x25,0xCC,0x43,0x3C,0x0D,0x79,
		0x32,0xEE,0x48,0x42,0x1C,0x8D,0x81,0xDB,0x94,0x62,0x8B,0x1F,0x82,0x36,0xA0,0x24,0xF4,0x5E,0x15,0x24,0xF0,0xA0,0x5F,0x92,0xCD,0x9E,0xA7,0xE7
	};

	int result = uECC_verify(publicKey, hash, 28, signature, curve);
	printf("ECDSA_Cross_Dbl_UnitTest: %d\n", result);
	return result;
}

int ECDSA_Cross_O_UnitTest()
{
	uECC_Curve curve = uECC_secp224r1();

	// publicKey = 
	// 17061818990515146033181180181647268932502676602253394570592180243932, 
	// 23802495863056426356972272754487540685330015937921535731093129183691
	uint8_t publicKey[56] = {
		0xA2,0x02,0xFC,0x06,0x4C,0xB0,0xE4,0x76,0xD2,0x4F,0x35,0x9B,0x05,0x43,0x73,0xB8,0xCD,0x71,0x8B,0xBA,0x89,0xC4,0xAA,0xDB,0xF7,0xCC,0x0D,0xDC,
		0xE2,0x04,0xA9,0x8A,0x6B,0x7D,0x97,0x97,0x6B,0x51,0x4D,0xBE,0x77,0xA9,0xD1,0x49,0x5E,0x76,0x4A,0x74,0xF1,0x6F,0xB3,0xED,0x0A,0x7C,0xC1,0xCB
	};

	// hash = {10379077808108938958641072404928976658030972167682803400239092956849}
	uint8_t hash[28] = {
		0x62,0x8E,0x23,0xFA,0x1C,0x7C,0x25,0xAB,0x47,0x9D,0x8B,0xAD,0x18,0xD1,0x38,0x47,0xB2,0x8B,0x32,0xF3,0x65,0x0A,0xEA,0x8D,0xEE,0x61,0x7E,0xB1
	};

	// r,s = 
	// {17061818990515146033181180181647268932502676602253394570592180243932}, 
	// {7814581815902928108437170233892873630154207598065720733985197713395}
	uint8_t signature[56] = {
		0xA2,0x02,0xFC,0x06,0x4C,0xB0,0xE4,0x76,0xD2,0x4F,0x35,0x9B,0x05,0x43,0x73,0xB8,0xCD,0x71,0x8B,0xBA,0x89,0xC4,0xAA,0xDB,0xF7,0xCC,0x0D,0xDC,
		0x4A,0x34,0x32,0x33,0xFA,0xD2,0x3D,0x74,0x27,0xDB,0x8D,0x5C,0xFC,0x2A,0x6E,0x0F,0xEF,0xA6,0x4B,0xE6,0x6F,0x63,0x2A,0x2D,0x76,0x66,0xE7,0xF3
	};

	int result = uECC_verify(publicKey, hash, 28, signature, curve);
	printf("ECDSA_Cross_O_UnitTest: %d\n", result);
	return result;
}